"use client";
// Test comment
import { useState, useEffect, FormEvent } from "react";
import { motion, AnimatePresence } from "framer-motion";
import React from "react";
import Link from "next/link";
import { Analytics } from "@vercel/analytics/next";
import TokenDistributionMap from './components/TokenDistributionMap';
import TokenDistributionTable from './components/TokenDistributionTable';

// Generate a UUID (v4, lightweight)
function uuidv4() {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}

// Format elapsed seconds as H:M:S
function formatElapsed(secs: number) {
  const h = Math.floor(secs / 3600);
  const m = Math.floor((secs % 3600) / 60);
  const s = secs % 60;
  return `${h > 0 ? h + 'h ' : ''}${m > 0 ? m + 'm ' : ''}${s}s`;
}

// Inflation Trend Dashboard component
function InflationTrendDashboard({ elapsed }: { elapsed: number }) {
  // Constants
  const BASE_RATE = 0.0001; // Â¤/sec
  const DAYS_PROJECTION = 30;
  const SECONDS_IN_DAY = 86400;
  const APY = 0.03; // 3%
  const CHART_WIDTH = 320;
  const CHART_HEIGHT = 140;
  const CHART_PADDING = 20;
  const DAILY_RATE = BASE_RATE * SECONDS_IN_DAY;
  
  // Colors
  const actualColor = "#2563eb"; // blue-600
  const projectedColor = "#9333ea"; // purple-600
  
  // Current accrued amount
  const accrued = elapsed * BASE_RATE;
  const formattedAccrued = accrued.toFixed(2);
  
  // Animation state for numeric display
  const [flash, setFlash] = useState(false);
  const [animKey, setAnimKey] = useState(0);
  
  // Chart data state
  const [projectionData, setProjectionData] = useState<Array<{day: number, value: number}>>([]);
  const [actualData, setActualData] = useState<Array<{day: number, value: number}>>([]);
  const [maxValue, setMaxValue] = useState(0);
  
  // Tooltip state
  const [hoveredPoint, setHoveredPoint] = useState<{
    day: number, 
    value: number,
    dailyGrowth: number,
    isProjected: boolean
  } | null>(null);
  
  // Effect for flashing animation on value change
  useEffect(() => {
    setFlash(true);
    setAnimKey((k) => k + 1);
    const timeout = setTimeout(() => setFlash(false), 200);
    return () => clearTimeout(timeout);
  }, [elapsed]);
  
  // Generate chart data with deterministic values
  useEffect(() => {
    // Generate projection data
    const newProjectionData = [];
    let currentValue = accrued;
    
    // Daily compound rate (APY converted to daily)
    const dailyRate = Math.pow(1 + APY, 1/365) - 1;
    
    // Start with current day
    newProjectionData.push({ day: 0, value: currentValue });
    
    // Project for next 30 days
    for (let day = 1; day <= DAYS_PROJECTION; day++) {
      // Add daily accrual
      currentValue += DAILY_RATE;
      
      // Apply compound interest
      currentValue *= (1 + dailyRate);
      
      newProjectionData.push({ day, value: currentValue });
    }
    
    // Generate actual data (deterministic variation)
    const newActualData = newProjectionData.map((point, index) => {
      // Create deterministic variation based on day number instead of random
      const variation = index === 0 ? 1 : 0.9 + (((point.day * 13) % 20) / 100);
      return {
        day: point.day,
        value: index === 0 ? point.value : point.value * variation
      };
    });
    
    // Find max value for scaling
    const newMaxValue = Math.max(
      ...newProjectionData.map(d => d.value),
      ...newActualData.map(d => d.value)
    ) * 1.1; // Add 10% headroom
    
    setProjectionData(newProjectionData);
    setActualData(newActualData);
    setMaxValue(newMaxValue);
  }, [elapsed, accrued, DAILY_RATE]);
  
  // Convert data points to SVG path
  const createPath = (data: { day: number, value: number }[]) => {
    if (data.length === 0) return "";
    
    const scaleX = (day: number) => CHART_PADDING + (day / DAYS_PROJECTION) * (CHART_WIDTH - 2 * CHART_PADDING);
    const scaleY = (value: number) => CHART_HEIGHT - CHART_PADDING - (value / maxValue) * (CHART_HEIGHT - 2 * CHART_PADDING);
    
    let path = `M ${scaleX(data[0].day)} ${scaleY(data[0].value)}`;
    
    for (let i = 1; i < data.length; i++) {
      path += ` L ${scaleX(data[i].day)} ${scaleY(data[i].value)}`;
    }
    
    return path;
  };
  
  // Create area fill for the chart
  const createAreaPath = (data: { day: number, value: number }[]) => {
    if (data.length === 0) return "";
    
    const scaleX = (day: number) => CHART_PADDING + (day / DAYS_PROJECTION) * (CHART_WIDTH - 2 * CHART_PADDING);
    const scaleY = (value: number) => CHART_HEIGHT - CHART_PADDING - (value / maxValue) * (CHART_HEIGHT - 2 * CHART_PADDING);
    
    let path = `M ${scaleX(data[0].day)} ${scaleY(data[0].value)}`;
    
    for (let i = 1; i < data.length; i++) {
      path += ` L ${scaleX(data[i].day)} ${scaleY(data[i].value)}`;
    }
    
    // Complete the area by adding bottom points
    path += ` L ${scaleX(data[data.length - 1].day)} ${CHART_HEIGHT - CHART_PADDING}`;
    path += ` L ${scaleX(data[0].day)} ${CHART_HEIGHT - CHART_PADDING} Z`;
    
    return path;
  };
  
  // Handle chart mouse movement for tooltips
  const handleChartMouseMove = (e: React.MouseEvent<SVGSVGElement>) => {
    if (projectionData.length === 0 || actualData.length === 0) return;
    
    const svgRect = e.currentTarget.getBoundingClientRect();
    const mouseX = e.clientX - svgRect.left;
    
    // Convert x position to day
    const day = Math.max(0, Math.min(DAYS_PROJECTION, 
      ((mouseX - CHART_PADDING) / (CHART_WIDTH - 2 * CHART_PADDING)) * DAYS_PROJECTION
    ));
    
    // Find closest day in data
    const closestDay = Math.round(day);
    const projectionPoint = projectionData.find(p => p.day === closestDay);
    const actualPoint = actualData.find(p => p.day === closestDay);
    
    if (!projectionPoint || !actualPoint) return;
    
    // Determine if we're closer to projection or actual line
    const scaleY = (value: number) => CHART_HEIGHT - CHART_PADDING - (value / maxValue) * (CHART_HEIGHT - 2 * CHART_PADDING);
    const projectionY = scaleY(projectionPoint.value);
    const actualY = scaleY(actualPoint.value);
    
    const mouseY = e.clientY - svgRect.top;
    const isProjected = Math.abs(mouseY - projectionY) < Math.abs(mouseY - actualY);
    
    const point = isProjected ? projectionPoint : actualPoint;
    
    // Calculate daily growth
    const prevDay = Math.max(0, closestDay - 1);
    const prevPoint = isProjected 
      ? projectionData.find(p => p.day === prevDay) 
      : actualData.find(p => p.day === prevDay);
    
    let dailyGrowth = 0;
    if (prevPoint && prevPoint.value > 0) {
      dailyGrowth = ((point.value - prevPoint.value) / prevPoint.value) * 100;
    }
    
    setHoveredPoint({
      day: point.day,
      value: point.value,
      dailyGrowth,
      isProjected
    });
  };
  
  // Handle chart mouse leave
  const handleChartMouseLeave = () => {
    setHoveredPoint(null);
  };
  
  return (
    <div className="w-full bg-gray-50 rounded-lg p-3 p-4 my-4">
      <h3 className="text-sm font-medium text-gray-700">Inflation Trend Dashboard</h3>
      
      {/* Accrued amount with animation */}
      <div className="flex items-center justify-center my-2">
        <AnimatePresence mode="wait" initial={false}>
          <motion.div
            key={animKey}
            initial={{ scale: 1 }}
            animate={{ scale: flash ? 1.05 : 1 }}
            transition={{ duration: 0.2 }}
            className="text-center"
          >
            <div className="text-gray-600 text-xs">You&apos;ve accrued:</div>
            <div className={`text-2xl sm:text-3xl font-bold ${flash ? "text-blue-500" : "text-black"}`}>
              Â¤{formattedAccrued}
            </div>
          </motion.div>
        </AnimatePresence>
      </div>
      
      {/* Stats display outside chart */}
      {hoveredPoint && (
        <div className="flex flex-wrap justify-center gap-4 mb-2 text-xs">
          <div className="bg-white px-3 py-2 rounded-md shadow-sm">
            <span className="text-gray-500">Day:</span>
            <span className="ml-1 font-medium">{hoveredPoint.day}</span>
          </div>
          <div className="bg-white px-3 py-2 rounded-md shadow-sm">
            <span className="text-gray-500">Value:</span>
            <span className="ml-1 font-medium">Â¤{hoveredPoint.value.toFixed(2)}</span>
          </div>
          <div className="bg-white px-3 py-2 rounded-md shadow-sm">
            <span className="text-gray-500">Daily:</span>
            <span className="ml-1 font-medium">Â¤{DAILY_RATE.toFixed(4)}</span>
          </div>
          <div className="bg-white px-3 py-2 rounded-md shadow-sm">
            <span className="text-gray-500">Growth:</span>
            <span className={`ml-1 font-medium ${hoveredPoint.dailyGrowth > 0 ? 'text-green-500' : 'text-red-500'}`}>
              {hoveredPoint.dailyGrowth > 0 ? '+' : ''}{hoveredPoint.dailyGrowth.toFixed(2)}%
            </span>
          </div>
        </div>
      )}
      
      {/* Projection chart */}
      <div className="relative bg-white rounded-md shadow-sm p-2">
        <svg 
          width={CHART_WIDTH} 
          height={CHART_HEIGHT} 
          className="w-full h-auto"
          onMouseMove={handleChartMouseMove}
          onMouseLeave={handleChartMouseLeave}
        >
          {/* Grid lines */}
          {[0, 0.25, 0.5, 0.75, 1].map((ratio) => (
            <line 
              key={`grid-y-${ratio}`}
              x1={CHART_PADDING} 
              y1={CHART_HEIGHT - CHART_PADDING - ratio * (CHART_HEIGHT - 2 * CHART_PADDING)}
              x2={CHART_WIDTH - CHART_PADDING} 
              y2={CHART_HEIGHT - CHART_PADDING - ratio * (CHART_HEIGHT - 2 * CHART_PADDING)}
              stroke="#e5e7eb" 
              strokeWidth="1" 
            />
          ))}
          
          {[0, 0.25, 0.5, 0.75, 1].map((ratio) => (
            <line 
              key={`grid-x-${ratio}`}
              x1={CHART_PADDING + ratio * (CHART_WIDTH - 2 * CHART_PADDING)} 
              y1={CHART_PADDING}
              x2={CHART_PADDING + ratio * (CHART_WIDTH - 2 * CHART_PADDING)} 
              y2={CHART_HEIGHT - CHART_PADDING}
              stroke="#e5e7eb" 
              strokeWidth="1" 
            />
          ))}
          
          {/* X-axis */}
          <line 
            x1={CHART_PADDING} 
            y1={CHART_HEIGHT - CHART_PADDING} 
            x2={CHART_WIDTH - CHART_PADDING} 
            y2={CHART_HEIGHT - CHART_PADDING} 
            stroke="#9ca3af" 
            strokeWidth="1.5" 
          />
          
          {/* Y-axis */}
          <line 
            x1={CHART_PADDING} 
            y1={CHART_PADDING} 
            x2={CHART_PADDING} 
            y2={CHART_HEIGHT - CHART_PADDING} 
            stroke="#9ca3af" 
            strokeWidth="1.5" 
          />
          
          {/* X-axis labels */}
          <text x={CHART_PADDING} y={CHART_HEIGHT - 5} fontSize="10" fill="#6b7280" textAnchor="middle">0</text>
          <text x={CHART_WIDTH/2} y={CHART_HEIGHT - 5} fontSize="10" fill="#6b7280" textAnchor="middle">15</text>
          <text x={CHART_WIDTH - CHART_PADDING} y={CHART_HEIGHT - 5} fontSize="10" fill="#6b7280" textAnchor="middle">30</text>
          <text x={CHART_WIDTH/2} y={CHART_HEIGHT - CHART_PADDING + 15} fontSize="10" fill="#6b7280" textAnchor="middle">Days</text>
          
          {/* Y-axis labels */}
          {maxValue > 0 && [0, 0.5, 1].map((ratio) => (
            <text 
              key={`label-y-${ratio}`}
              x={CHART_PADDING - 5} 
              y={CHART_HEIGHT - CHART_PADDING - ratio * (CHART_HEIGHT - 2 * CHART_PADDING) + 3} 
              fontSize="10" 
              fill="#6b7280"
              textAnchor="end"
            >
              Â¤{(maxValue * ratio).toFixed(2)}
            </text>
          ))}
          
          {/* Area fill for actual data */}
          <path 
            d={createAreaPath(actualData)} 
            fill={`${actualColor}15`} 
          />
          
          {/* Line for actual data */}
          <path 
            d={createPath(actualData)} 
            fill="none" 
            stroke={actualColor} 
            strokeWidth="2.5" 
            strokeLinecap="round"
          />
          
          {/* Dashed line for projection */}
          <path 
            d={createPath(projectionData)} 
            fill="none" 
            stroke={projectedColor} 
            strokeWidth="2" 
            strokeDasharray="4 2" 
          />
          
          {/* Hover point indicator */}
          {hoveredPoint && (
            <circle 
              cx={CHART_PADDING + (hoveredPoint.day / DAYS_PROJECTION) * (CHART_WIDTH - 2 * CHART_PADDING)}
              cy={CHART_HEIGHT - CHART_PADDING - (hoveredPoint.value / maxValue) * (CHART_HEIGHT - 2 * CHART_PADDING)}
              r="4" 
              fill={hoveredPoint.isProjected ? projectedColor : actualColor}
              stroke="white"
              strokeWidth="1.5"
            />
          )}
          
          {/* Legend */}
          <g transform={`translate(${CHART_WIDTH - 120}, 15)`}>
            <rect width="10" height="3" fill={actualColor} rx="1"/>
            <text x="15" y="4" fontSize="10" fill="#374151">Actual</text>
            
            <g transform="translate(0, 12)">
              <line x1="0" y1="1.5" x2="10" y2="1.5" stroke={projectedColor} strokeWidth="2" strokeDasharray="2 1" />
              <text x="15" y="4" fontSize="10" fill="#374151">Projected (3% APY)</text>
            </g>
          </g>
        </svg>
      </div>
      
      {/* Footer note */}
      <div className="text-center text-xs text-gray-500 mt-2">
        Hover over chart to see detailed projections
      </div>
    </div>
  );
}

// Live USD Counter component
function LiveUsdCounter({ elapsed }: { elapsed: number }) {
  // Each second, increment by Â¤0.0001
  const base = 0.0001;
  const earned = elapsed * base;
  // Format to 4 decimals, but animate last two
  const formatted = earned.toFixed(4);
  const [main, last2] = [formatted.slice(0, -2), formatted.slice(-2)];
  // Animation state
  const [flash, setFlash] = useState(false);
  const [animKey, setAnimKey] = useState(0);

  useEffect(() => {
    setFlash(true);
    setAnimKey((k) => k + 1);
    const timeout = setTimeout(() => setFlash(false), 200);
    return () => clearTimeout(timeout);
  }, [elapsed]);

  return (
    <div className="w-full max-w-md mx-auto flex flex-col items-center justify-center text-xs text-gray-800 my-3 select-none">
      <div className="mb-1 text-xs text-gray-600">â‚¿UBI:</div>
      <div className="flex items-center">
        <span className="font-mono text-sm font-medium text-gray-700 mr-0.5">Â¤</span>
        <span className="font-mono text-lg sm:text-xl font-semibold text-black">{main}</span>
        <AnimatePresence mode="wait" initial={false}>
          <motion.span
            key={animKey}
            initial={{ scale: 1 }}
            animate={{ scale: [1, 1.1, 1] }}
            transition={{ duration: 0.3, times: [0, 0.5, 1] }}
            className={`font-mono text-lg sm:text-xl font-semibold ml-0.5 ${flash ? "text-yellow-500" : "text-black"}`}
          >
            {last2}
          </motion.span>
        </AnimatePresence>
      </div>
    </div>
  );
}

// SVG Line Chart Component
function LineCharts({ elapsed }: { elapsed: number }) {
  // Constants
  const SECONDS = 300; // 5 min window
  const USER_RATE = 0.0001; // Â¤/sec
  const ECOSYSTEM_RATE = 0.001; // Â¤/sec (example, can be changed)
  const INFLATION = 0.03; // 3% annual
  const WIDTH = 180;
  const HEIGHT = 80;
  const PADDING = 24;
  // Colors
  const userColor = "#2563eb"; // blue-600
  const ecoColor = "#f59e42"; // orange-400
  // Data arrays
  const [userData, setUserData] = useState<{ t: number; v: number }[]>([]);
  const [ecoData, setEcoData] = useState<{ t: number; v: number }[]>([]);
  // Track max values to create a fixed scale
  const [maxValues, setMaxValues] = useState({ user: 0, eco: 0 });

  // Inflation factor per second
  const inflationPerSec = Math.pow(1 + INFLATION, 1 / (365 * 24 * 3600));

  // On each tick, add new data point
  useEffect(() => {
    if (elapsed === 0) {
      setUserData([]);
      setEcoData([]);
      setMaxValues({ user: 0, eco: 0 });
      return;
    }

    setUserData(prevUserData => {
      const lastPointV = prevUserData.length > 0 ? prevUserData[prevUserData.length - 1].v : 0;
      const nextUserValue = (lastPointV + USER_RATE) * inflationPerSec;
      
      setMaxValues(currentMaxVals => {
        if (nextUserValue > currentMaxVals.user) {
          return { ...currentMaxVals, user: nextUserValue };
        }
        return currentMaxVals;
      });
      
      const newPoint = { t: elapsed, v: nextUserValue };
      let updatedUserData;
      if (prevUserData.length === 0 && elapsed > 0) {
           // Add an initial point at t=0 (or t=elapsed-1) if this is the first data point after reset
           updatedUserData = [{t: Math.max(0, elapsed -1) , v:0}, newPoint];
      } else {
          updatedUserData = [...prevUserData, newPoint];
      }
      return updatedUserData.length > SECONDS ? updatedUserData.slice(-SECONDS) : updatedUserData;
    });

    setEcoData(prevEcoData => {
      const lastPointV = prevEcoData.length > 0 ? prevEcoData[prevEcoData.length - 1].v : 0;
      const nextEcoValue = (lastPointV + ECOSYSTEM_RATE) * inflationPerSec;

      setMaxValues(currentMaxVals => {
        if (nextEcoValue > currentMaxVals.eco) {
          return { ...currentMaxVals, eco: nextEcoValue };
        }
        return currentMaxVals;
      });

      const newPoint = { t: elapsed, v: nextEcoValue };
      let updatedEcoData;
       if (prevEcoData.length === 0 && elapsed > 0) {
          // Add an initial point at t=0 (or t=elapsed-1) if this is the first data point after reset
          updatedEcoData = [{t: Math.max(0, elapsed -1), v:0}, newPoint];
      } else {
          updatedEcoData = [...prevEcoData, newPoint];
      }
      return updatedEcoData.length > SECONDS ? updatedEcoData.slice(-SECONDS) : updatedEcoData;
    });
  }, [elapsed, inflationPerSec]); // Added inflationPerSec to the dependency array

  // Helper: format time
  function fmt(t: number) {
    const d = new Date(t * 1000);
    return d.toISOString().substr(11, 8);
  }

  // Helper: get min/max for Y axis with safety checks
  function getYRange(data: { v: number }[], isUserData: boolean) {
    // Always use 0 as minimum
    const min = 0;
    
    // Use tracked max values instead of calculating from current visible data
    // This ensures we show the true exponential growth without auto-scaling
    // Add 30% headroom to show growth room
    const maxValue = isUserData ? maxValues.user : maxValues.eco;
    const max = maxValue * 1.3 || 1; // Default to 1 if maxValue is 0
    
    return [min, max];
  }

  // Helper: build SVG path with cubic interpolation
  function buildPath(data: { t: number; v: number }[], color: string) {
    if (data.length < 2) return ""; // Need at least 2 points
    
    // Filter out invalid data points
    const validData = data.filter(d => !isNaN(d.t) && !isNaN(d.v) && isFinite(d.t) && isFinite(d.v));
    if (validData.length < 2) return "";
    
    const [minY, maxY] = getYRange(validData, color === userColor);
    const minT = validData[0].t;
    const maxT = validData[validData.length - 1].t;
    
    // Avoid division by zero
    const timeRange = maxT - minT || 1;
    const valueRange = maxY - minY || 1;
    
    const scaleX = (t: number) => PADDING + ((t - minT) / timeRange) * (WIDTH - 2 * PADDING);
    const scaleY = (v: number) => HEIGHT - PADDING - ((v - minY) / valueRange) * (HEIGHT - 2 * PADDING);
    
    let d = `M${scaleX(validData[0].t)},${scaleY(validData[0].v)}`;
    
    for (let i = 1; i < validData.length; i++) {
      const p0 = validData[i - 1], p1 = validData[i];
      const cpx = (scaleX(p0.t) + scaleX(p1.t)) / 2;
      d += ` C${cpx},${scaleY(p0.v)} ${cpx},${scaleY(p1.v)} ${scaleX(p1.t)},${scaleY(p1.v)}`;
    }
    
    return d;
  }

  // Helper: build gradient fill path
  function buildFill(data: { t: number; v: number }[], color: string) {
    if (data.length < 2) return ""; // Need at least 2 points
    
    // Filter out invalid data points
    const validData = data.filter(d => !isNaN(d.t) && !isNaN(d.v) && isFinite(d.t) && isFinite(d.v));
    if (validData.length < 2) return "";
    
    const [minY, maxY] = getYRange(validData, color === userColor);
    const minT = validData[0].t;
    const maxT = validData[validData.length - 1].t;
    
    // Avoid division by zero
    const timeRange = maxT - minT || 1;
    const valueRange = maxY - minY || 1;
    
    const scaleX = (t: number) => PADDING + ((t - minT) / timeRange) * (WIDTH - 2 * PADDING);
    const scaleY = (v: number) => HEIGHT - PADDING - ((v - minY) / valueRange) * (HEIGHT - 2 * PADDING);
    
    let d = `M${scaleX(validData[0].t)},${scaleY(validData[0].v)}`;
    
    for (let i = 1; i < validData.length; i++) {
      const p0 = validData[i - 1], p1 = validData[i];
      const cpx = (scaleX(p0.t) + scaleX(p1.t)) / 2;
      d += ` C${cpx},${scaleY(p0.v)} ${cpx},${scaleY(p1.v)} ${scaleX(p1.t)},${scaleY(p1.v)}`;
    }
    
    // Close path to bottom
    d += ` L${scaleX(validData[validData.length - 1].t)},${HEIGHT - PADDING}`;
    d += ` L${scaleX(validData[0].t)},${HEIGHT - PADDING} Z`;
    
    return d;
  }

  // Y axis ticks
  function yTicks(data: { v: number }[], isUserData: boolean) {
    if (data.length < 2) return [0, 0.5, 1]; // Default ticks for empty data
    
    const [minY, maxY] = getYRange(data, isUserData);
    return [minY, (minY + maxY) / 2, maxY];
  }

  // X axis ticks (show 3: left, center, right)
  function xTicks(data: { t: number }[]) {
    if (data.length < 2) return [0, 0, 0]; // Default ticks for empty data
    
    const minT = data[0].t;
    const maxT = data[data.length - 1].t;
    return [minT, (minT + maxT) / 2, maxT];
  }

  // Create a memoized version of the Chart component to prevent unnecessary re-renders
  const MemoizedChart = React.memo(function Chart({ 
    data, 
    color, 
    label
  }: { 
    data: { t: number; v: number }[]; 
    color: string; 
    label: string;
  }) {
    // Early return for empty chart with placeholder
    if (data.length < 2) {
      return (
        <svg width={WIDTH} height={HEIGHT} viewBox={`0 0 ${WIDTH} ${HEIGHT}`} className="bg-white rounded shadow-sm">
          <text x={WIDTH/2 - 30} y={HEIGHT/2} fontSize="10" fill="#888">Collecting data...</text>
          <g>
            <rect x={WIDTH-70} y={6} width={8} height={8} rx={2} fill={color} />
            <text x={WIDTH-58} y={13} fontSize="10" fill="#222">{label}</text>
            <text x={WIDTH-58} y={22} fontSize="8" fill="#888">+3%/yr</text>
          </g>
        </svg>
      );
    }
    
    // Make a safe copy to prevent rendering issues
    const safeData = data.filter(d => !isNaN(d.t) && !isNaN(d.v) && isFinite(d.t) && isFinite(d.v));
    
    // Safety check
    if (safeData.length < 2) {
      return (
        <svg width={WIDTH} height={HEIGHT} viewBox={`0 0 ${WIDTH} ${HEIGHT}`} className="bg-white rounded shadow-sm">
          <text x={WIDTH/2 - 30} y={HEIGHT/2} fontSize="10" fill="#888">Collecting data...</text>
          <g>
            <rect x={WIDTH-70} y={6} width={8} height={8} rx={2} fill={color} />
            <text x={WIDTH-58} y={13} fontSize="10" fill="#222">{label}</text>
            <text x={WIDTH-58} y={22} fontSize="8" fill="#888">+3%/yr</text>
          </g>
        </svg>
      );
    }
    
    const isUserData = label === "You";
    const [minY, maxY] = getYRange(safeData, isUserData);
    const minT = safeData[0].t;
    const maxT = safeData[safeData.length - 1].t;
    
    // Avoid division by zero
    const timeRange = maxT - minT || 1;
    const valueRange = maxY - minY || 1;
    
    const scaleX = (t: number) => PADDING + ((t - minT) / timeRange) * (WIDTH - 2 * PADDING);
    const scaleY = (v: number) => HEIGHT - PADDING - ((v - minY) / valueRange) * (HEIGHT - 2 * PADDING);
    
    return (
      <svg width={WIDTH} height={HEIGHT} viewBox={`0 0 ${WIDTH} ${HEIGHT}`} className="bg-white rounded shadow-sm">
        {/* Gradient */}
        <defs>
          <linearGradient id={label+"-grad"} x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stopColor={color} stopOpacity="0.18" />
            <stop offset="100%" stopColor={color} stopOpacity="0.01" />
          </linearGradient>
        </defs>
        {/* Fill */}
        <path d={buildFill(safeData, color)} fill={`url(#${label}-grad)`} />
        {/* Line */}
        <path d={buildPath(safeData, color)} fill="none" stroke={color} strokeWidth="2.5" />
        {/* Y axis ticks */}
        {yTicks(safeData, isUserData).map((y, i) => (
          <text key={i} x={2} y={scaleY(y) + 4} fontSize="8" fill="#888">{y.toFixed(2)}</text>
        ))}
        {/* X axis ticks */}
        {xTicks(safeData).map((t, i) => (
          <text key={i} x={scaleX(t) - 12} y={HEIGHT - 2} fontSize="8" fill="#888">{fmt(t)}</text>
        ))}
        {/* Legend */}
        <g>
          <rect x={WIDTH-70} y={6} width={8} height={8} rx={2} fill={color} />
          <text x={WIDTH-58} y={13} fontSize="10" fill="#222">{label}</text>
          <text x={WIDTH-58} y={22} fontSize="8" fill="#888">+3%/yr</text>
        </g>
      </svg>
    );
  });

  // Responsive layout: stack on mobile, side-by-side on desktop
  return (
    <div className="w-full my-4">
      <h3 className="text-sm font-medium text-gray-700 mb-2">Real-time Growth Charts</h3>
      <div className="flex flex-col sm:flex-row gap-3 w-full justify-center items-center">
        <div className="w-full sm:w-1/2">
          <MemoizedChart data={userData} color={userColor} label="You" />
        </div>
        <div className="w-full sm:w-1/2">
          <MemoizedChart data={ecoData} color={ecoColor} label="Ecosystem" />
        </div>
      </div>
    </div>
  );
}

// YouTube Video Card Component (refactored for props and mobile design)
const YouTubeVideoCard = React.memo(function YouTubeVideoCard({ title, videoId, link, isShort }: { title: string; videoId: string; link: string; isShort?: boolean }) {
  const [isLoading, setIsLoading] = useState(true);
  // Shorts use a different embed URL
  const embedUrl = isShort
    ? `https://www.youtube.com/embed/${videoId}?autoplay=0&modestbranding=1&rel=0&showinfo=0&controls=1&loop=0&playlist=${videoId}`
    : `https://www.youtube.com/embed/${videoId}`;
  return (
    <div className="w-full max-w-md mx-auto bg-white rounded-xl shadow-md overflow-hidden mb-6 flex flex-col border border-gray-100">
      <div className="aspect-video w-full bg-gray-100 relative">
        {isLoading && (
          <div className="absolute inset-0 flex items-center justify-center bg-gray-100 z-10">
            <div className="w-10 h-10 border-4 border-gray-200 border-t-blue-500 rounded-full animate-spin"></div>
          </div>
        )}
        <iframe
          className="w-full h-full absolute top-0 left-0"
          src={embedUrl}
          title={title}
          frameBorder="0"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
          referrerPolicy="strict-origin-when-cross-origin"
          allowFullScreen
          onLoad={() => setIsLoading(false)}
        ></iframe>
      </div>
      <div className="flex flex-col items-center justify-center px-4 py-3">
        <div className="font-semibold text-base text-gray-900 text-center mb-1 leading-tight">{title}</div>
        <a
          href={link}
          target="_blank"
          rel="noopener noreferrer"
          className="text-xs text-blue-600 hover:underline text-center break-all"
        >
          Watch on YouTube
        </a>
      </div>
    </div>
  );
});

// Video Section with two videos, mobile-optimized
function VideoSection() {
  return (
    <section id="video" className="px-2 sm:px-4 py-8 bg-gray-50">
      <h2 className="text-lg font-bold mb-4 text-black text-center">Featured Videos</h2>
      <div className="flex flex-col gap-4 w-full max-w-2xl mx-auto">
        <YouTubeVideoCard
          title="social x economic identity"
          videoId="AEoTS5U-KeI"
          link="https://www.youtube.com/shorts/AEoTS5U-KeI"
          isShort={true}
        />
        <YouTubeVideoCard
          title="Bitcoin UBI Playbook (wip)"
          videoId="WbbIzGQcGdU"
          link="https://www.youtube.com/watch?v=WbbIzGQcGdU"
        />
      </div>
    </section>
  );
}

// Login Modal Component
function LoginModal({ isOpen, onClose }: { isOpen: boolean; onClose: () => void }) {
  const [loginPassword, setLoginPassword] = useState("");
  const [isLoggingIn, setIsLoggingIn] = useState(false);
  
  if (!isOpen) return null;

  const handleSubmit = async (e: FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    setIsLoggingIn(true);
    
    try {
      const response = await fetch('/api/account/login', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ password: loginPassword }),
      });
      
      const data = await response.json();
      
      if (!response.ok) {
        throw new Error(data.error || 'Login failed');
      }
      
      // Store user data in localStorage
      localStorage.setItem('bubiwot_user_id', data.userId);
      localStorage.setItem('bubiwot_user_alias', data.alias);
      localStorage.setItem('bubiwot_user_password', loginPassword);
      
      // Reload to update UI
      window.location.reload();
      
      setLoginPassword("");
      onClose();
    } catch (error) {
      console.error("Login failed:", error);
      alert(`Login failed: ${error instanceof Error ? error.message : "Unknown error"}`);
    } finally {
      setIsLoggingIn(false);
    }
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
        <div className="flex justify-between items-center mb-4">
          <h2 className="text-xl font-semibold text-gray-800">Login</h2>
          <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        <form onSubmit={handleSubmit}>
          <div className="mb-4">
            <label htmlFor="recoveryKey" className="block text-sm font-medium text-gray-700 mb-1">
              Recovery Key / Password
            </label>
            <input
              type="password"
              id="recoveryKey"
              value={loginPassword}
              onChange={(e) => setLoginPassword(e.target.value)}
              className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-black"
              placeholder="Enter your key"
            />
          </div>
          <button
            type="submit"
            disabled={isLoggingIn}
            className="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition flex items-center justify-center"
          >
            {isLoggingIn ? (
              <>
                <svg className="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                  <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Logging in...
              </>
            ) : (
              "Recover Account"
            )}
          </button>
        </form>
        <p className="text-xs text-gray-500 mt-3 text-center">
          Account recovery is under development.
        </p>
      </div>
    </div>
  );
}

// User Modal Component
function UserModal({ 
  isOpen, 
  onClose, 
  userData, 
  onLogin, 
  // eslint-disable-next-line @typescript-eslint/no-unused-vars
  _onLogout 
}: { 
  isOpen: boolean; 
  onClose: () => void;
  userData: {
    userId: string;
    alias: string;
    password: string;
    hasLoggedIn: boolean;
  };
  onLogin: (password: string) => void;
  _onLogout: () => void; // Update the interface to match
}) {
  const [loginPassword, setLoginPassword] = useState("");
  const [isLoggingIn, setIsLoggingIn] = useState(false);
  const [isCopied, setIsCopied] = useState(false);
  const [localPassword, setLocalPassword] = useState("");
  
  // Animation for strobing effect
  const [isStrobing, setIsStrobing] = useState(false);
  
  // Set up strobing animation if user hasn't logged in
  useEffect(() => {
    if (!userData.hasLoggedIn && isOpen) {
      const interval = setInterval(() => {
        setIsStrobing(prev => !prev);
      }, 700); // Toggle every 700ms
      
      return () => clearInterval(interval);
    }
  }, [userData.hasLoggedIn, isOpen]);
  
  // Update local password when userData changes
  useEffect(() => {
    if (userData.password) {
      setLocalPassword(userData.password);
    }
  }, [userData.password]);
  
  if (!isOpen) return null;
  
  const handleSubmit = async (e: FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    setIsLoggingIn(true);
    
    try {
      await onLogin(loginPassword);
      setLoginPassword("");
    } catch (error) {
      console.error("Login failed:", error);
    } finally {
      setIsLoggingIn(false);
    }
  };
  
  const handleCopyPassword = async () => {
    try {
      await navigator.clipboard.writeText(localPassword);
      setIsCopied(true);
      setTimeout(() => setIsCopied(false), 2000);
    } catch (error) {
      console.error("Failed to copy to clipboard:", error);
      
      // Fallback method if clipboard API fails
      const textArea = document.createElement("textarea");
      textArea.value = localPassword;
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      try {
        document.execCommand("copy");
        setIsCopied(true);
        setTimeout(() => setIsCopied(false), 2000);
      } catch (err) {
        console.error("Fallback copy failed:", err);
        alert("Failed to copy to clipboard. Please copy manually.");
      }
      document.body.removeChild(textArea);
    }
  };
  
  const handleRandomizePassword = async () => {
    try {
      const response = await fetch('/api/account/create', { method: 'POST' });
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      const data = await response.json();
      if (data.password) {
        setLocalPassword(data.password);
      }
    } catch (error) {
      console.error("Failed to randomize password:", error);
    }
  };
  
  const handleClearPassword = () => {
    setLocalPassword("");
  };
  
  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
        <div className="flex justify-between items-center mb-4">
          <h2 className="text-xl font-semibold text-gray-800">Account Details</h2>
          <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        
        {/* User Info Section */}
        <div className="mb-6 p-4 bg-gray-50 rounded-md">
          <div className="grid grid-cols-4 gap-2 mb-3">
            <span className="text-sm font-medium text-gray-600 col-span-1">User ID:</span>
            <span className="text-sm text-gray-800 col-span-3 font-mono break-all">{userData.userId}</span>
          </div>
          <div className="grid grid-cols-4 gap-2 mb-3">
            <span className="text-sm font-medium text-gray-600 col-span-1">Alias:</span>
            <span className="text-sm text-gray-800 col-span-3">{userData.alias}</span>
          </div>
          
          {/* Password section with buttons */}
          <div className={`rounded p-2 ${!userData.hasLoggedIn && isStrobing ? 'bg-yellow-100' : ''}`}>
            <div className="flex items-center justify-between mb-2">
              <span className="text-sm font-medium text-gray-600">Password:</span>
              <div className="flex gap-1">
                <button 
                  onClick={handleRandomizePassword}
                  className="px-2 py-1 text-xs bg-gray-200 text-gray-700 rounded hover:bg-gray-300 flex items-center"
                  title="Generate new password"
                >
                  <span>ðŸ”„</span>
                </button>
                <button 
                  onClick={handleCopyPassword}
                  className="px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600 flex items-center min-w-[60px]"
                  title="Copy to clipboard"
                >
                  {isCopied ? "Copied!" : "Copy"}
                </button>
                <button 
                  onClick={handleClearPassword}
                  className="px-2 py-1 text-xs bg-gray-200 text-gray-700 rounded hover:bg-gray-300 flex items-center"
                  title="Clear password"
                >
                  <span>âœ•</span>
                </button>
              </div>
            </div>
            <div className="text-sm text-gray-800 font-mono break-all bg-white p-2 rounded border border-gray-200 min-h-[2.5rem]">
              {localPassword}
            </div>
          </div>
          
          {!userData.hasLoggedIn && (
            <div className="mt-3 text-xs text-yellow-600 flex items-center">
              <svg className="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
              </svg>
              This account has never been used to login
            </div>
          )}
        </div>
        
        {/* Login Form */}
        <form onSubmit={handleSubmit} className="mt-4">
          <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Login with Password
            </label>
            <div className={`flex ${!userData.hasLoggedIn && isStrobing ? 'bg-yellow-100' : ''} rounded`}>
              <input
                type="password"
                value={loginPassword}
                onChange={(e) => setLoginPassword(e.target.value)}
                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-black"
                placeholder="Enter your password"
              />
            </div>
          </div>
          <button
            type="submit"
            disabled={isLoggingIn || !loginPassword}
            className="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition flex items-center justify-center disabled:bg-blue-300"
          >
            {isLoggingIn ? (
              <>
                <svg className="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                  <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Logging in...
              </>
            ) : (
              "Login"
            )}
          </button>
        </form>
      </div>
    </div>
  );
}

// Finance Dashboard component
function FinanceDashboard({ elapsed }: { elapsed: number }) {
  return (
    <>
      {/* Live USD Counter */}
      <LiveUsdCounter elapsed={elapsed} />
      
      {/* Accrual Meter */}
      <AccrualMeter elapsed={elapsed} />
      
      {/* Mobile-Optimized Layout Container for financial charts */}
      <div className="w-full max-w-md mx-auto">
        {/* Inflation Trend Dashboard */}
        <InflationTrendDashboard elapsed={elapsed} />
        
        {/* Side-by-side SVG Line Charts */}
        <LineCharts elapsed={elapsed} />
      </div>
    </>
  );
}

// Profile Modal Component
function ProfileModal({ 
  isOpen, 
  onClose, 
  userData, 
  onUpdateAlias,
  onSwitchAccount,
  accruedValue,
  isFundingAccount,
  onFundAccount
}: { 
  isOpen: boolean; 
  onClose: () => void;
  userData: {
    userId: string;
    alias: string;
    credits: number;
  };
  onUpdateAlias: (newAlias: string) => Promise<void>;
  onSwitchAccount: (password: string) => Promise<void>;
  accruedValue: number;
  isFundingAccount: boolean;
  onFundAccount: () => Promise<void>;
}) {
  const [newAlias, setNewAlias] = useState("");
  const [switchPassword, setSwitchPassword] = useState("");
  const [isUpdatingAlias, setIsUpdatingAlias] = useState(false);
  const [isSwitchingAccount, setIsSwitchingAccount] = useState(false);
  const [error, setError] = useState<string | null>(null);
  
  useEffect(() => {
    if (isOpen) {
      setNewAlias("");
      setSwitchPassword("");
      setError(null);
    }
  }, [isOpen]);
  
  if (!isOpen) return null;
  
  const handleUpdateAlias = async (e: FormEvent) => {
    e.preventDefault();
    if (!newAlias.trim()) {
      setError("Please enter a new name");
      return;
    }
    
    // Make sure we have credits data
    if ((userData.credits || 0) < 0.000777) {
      setError("Not enough credits. You need 0.000777 credits to change your name.");
      return;
    }
    
    setIsUpdatingAlias(true);
    setError(null);
    
    try {
      await onUpdateAlias(newAlias);
      setNewAlias("");
    } catch (err) {
      setError(err instanceof Error ? err.message : "Failed to update name");
    } finally {
      setIsUpdatingAlias(false);
    }
  };
  
  const handleSwitchAccount = async (e: FormEvent) => {
    e.preventDefault();
    if (!switchPassword.trim()) {
      setError("Please enter a password");
      return;
    }
    
    // Make sure we have credits data
    if ((userData.credits || 0) < 0.000777) {
      setError("Not enough credits. You need 0.000777 credits to switch accounts.");
      return;
    }
    
    setIsSwitchingAccount(true);
    setError(null);
    
    try {
      await onSwitchAccount(switchPassword);
      setSwitchPassword("");
    } catch (err) {
      setError(err instanceof Error ? err.message : "Failed to switch account");
    } finally {
      setIsSwitchingAccount(false);
    }
  };
  
  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
        <div className="flex justify-between items-center mb-4">
          <h2 className="text-xl font-semibold text-gray-800">Profile Settings</h2>
          <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        
        {/* Credit Balance */}
        <div className="mb-6 p-4 bg-gray-50 rounded-md">
          <div className="flex justify-between items-center">
            <span className="text-sm font-medium text-gray-600">Credit Balance:</span>
            <span className="text-xl font-bold text-green-600">{(userData.credits || 0).toFixed(8)} Â¤</span>
          </div>
        </div>
        
        {error && (
          <div className="mb-4 p-3 bg-red-50 border border-red-200 text-red-700 rounded-md text-sm">
            {error}
          </div>
        )}
        
        {/* Change Name Form */}
        <form onSubmit={handleUpdateAlias} className="mb-6">
          <h3 className="text-md font-medium mb-2 text-gray-700">Change Name</h3>
          <div className="mb-3">
            <label className="block text-sm text-gray-600 mb-1">Current Name: <span className="font-medium">{userData.alias}</span></label>
            <div className="flex gap-2">
              <input
                type="text"
                value={newAlias}
                onChange={(e) => setNewAlias(e.target.value)}
                placeholder="New name"
                className="flex-1 px-3 py-2 text-sm text-black border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
              <button
                type="submit"
                disabled={isUpdatingAlias || !newAlias.trim() || (userData.credits || 0) < 0.000777}
                className="whitespace-nowrap px-3 py-2 text-sm bg-blue-500 text-white rounded-md hover:bg-blue-600 disabled:bg-blue-300 disabled:cursor-not-allowed flex items-center"
              >
                {isUpdatingAlias ? (
                  <>
                    <svg className="animate-spin -ml-1 mr-1 h-3 w-3 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                      <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                      <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Updating...
                  </>
                ) : (
                  <>Â¤10</>
                )}
              </button>
            </div>
            <p className="text-xs text-gray-500 mt-1">Changing your name costs 0.000777 credits</p>
          </div>
        </form>
        
        {/* Switch Account Form */}
        <form onSubmit={handleSwitchAccount}>
          <h3 className="text-md font-medium mb-2 text-gray-700">Switch Account</h3>
          <div className="mb-3">
            <div className="flex gap-2">
              <input
                type="password"
                value={switchPassword}
                onChange={(e) => setSwitchPassword(e.target.value)}
                placeholder="Account password"
                className="flex-1 px-3 py-2 text-sm text-black border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
              <button
                type="submit"
                disabled={isSwitchingAccount || !switchPassword.trim() || (userData.credits || 0) < 0.000777}
                className="whitespace-nowrap px-3 py-2 text-sm bg-blue-500 text-white rounded-md hover:bg-blue-600 disabled:bg-blue-300 disabled:cursor-not-allowed flex items-center"
              >
                {isSwitchingAccount ? (
                  <>
                    <svg className="animate-spin -ml-1 mr-1 h-3 w-3 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                      <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                      <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Switching...
                  </>
                ) : (
                  <>Â¤0.000777</>
                )}
              </button>
            </div>
            <p className="text-xs text-gray-500 mt-1">Switching accounts costs 0.000777 credits</p>
          </div>
        </form>
        
        {/* Fund Account Section */}
        <div className="mb-6">
          <h3 className="text-md font-medium mb-2 text-gray-700">Fund Account</h3>
          <div className="bg-gray-50 p-4 rounded-md">
            <div className="flex flex-col space-y-2">
              <div className="flex items-center justify-between">
                <span className="text-sm font-medium text-gray-600">Accrued Value:</span>
                <span className="text-md font-semibold text-green-600">{accruedValue.toFixed(8)} Â¤</span>
              </div>
              <button
                onClick={onFundAccount}
                disabled={accruedValue < 0.000777 || isFundingAccount}
                className="mt-2 w-full px-3 py-2 text-sm bg-green-500 text-white rounded-md hover:bg-green-600 disabled:bg-green-300 disabled:cursor-not-allowed flex items-center justify-center"
              >
                {isFundingAccount ? (
                  <>
                    <svg className="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                      <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                      <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Processing...
                  </>
                ) : (
                  <>Fund Account (Â¤0.000777 min)</>
                )}
              </button>
              <p className="text-xs text-gray-500 mt-1">Requires at least 0.000777 in accrued value</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

// Accrual Meter component
function AccrualMeter({ elapsed }: { elapsed: number }) {
  const BASE_RATE = 0.0001; // Â¤/sec, consistent with other components
  const MONTHLY_TARGET = 260; // Â¤/month

  // Calculate current value and percentage
  const currentValue = elapsed * BASE_RATE;
  const progressPercentage = Math.min((currentValue / MONTHLY_TARGET) * 100, 100);
  
  // Format for display with hundredths precision
  const formattedValue = currentValue.toFixed(2);
  
  // Animation states
  const [animKey, setAnimKey] = useState(0);
  
  // Update animation key on each elapsed change
  useEffect(() => {
    setAnimKey(k => k + 1);
  }, [elapsed]);

  return (
    <div className="w-full max-w-md mx-auto my-4 px-2">
      {/* Counter display */}
      <div className="text-center mb-2">
        <motion.div
          key={animKey}
          initial={{ opacity: 0.9, y: -2 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.15, ease: "easeOut" }}
          className="inline-block"
        >
          <span className="text-3xl font-bold text-gray-900">~Â¤{formattedValue}</span>
          <div className="text-xs text-gray-500 mt-1">Accrued value</div>
        </motion.div>
      </div>
      
      <div className="text-center mb-3">
        <button
          className="px-6 py-2 text-sm bg-gray-300 text-gray-700 rounded-md cursor-not-allowed"
          disabled
        >
          Send
        </button>
      </div>
      
      {/* Progress bar */}
      <div className="w-full bg-gray-200 rounded-full h-4 overflow-hidden shadow-inner">
        <div 
          className="h-4 rounded-full bg-gradient-to-r from-green-500 to-blue-600"
          style={{ 
            width: `${progressPercentage}%`, 
            transition: 'width 0.5s ease-out' 
          }}
        ></div>
      </div>
      <div className="text-center text-xs text-gray-600 mt-1">
        {progressPercentage.toFixed(1)}% of Â¤{MONTHLY_TARGET} monthly target
      </div>
    </div>
  );
}

export default function Home() {
  // Mock data
  const [userCount, setUserCount] = useState(0);
  const [totalBubi] = useState("???");
  const [tasks] = useState([
    { id: 1, title: "Invite a friend" },
    { id: 2, title: "Join Discord" },
  ]);
  const [messages] = useState([
    { id: 1, text: " ðŸ’ª", name: "Bobby", total_sats: 1000000 },
  ]);

  // Session ID and timer logic
  const [, setSessionId] = useState<string | null>(null);
  const [sessionStart, setSessionStart] = useState<number | null>(null);
  const [elapsed, setElapsed] = useState(0);
  // eslint-disable-next-line @typescript-eslint/no-unused-vars
  const [_isPasswordLoading, setIsPasswordLoading] = useState(false);
  const [showPasswordInput, setShowPasswordInput] = useState(false);
  const [passwordInput, setPasswordInput] = useState("");
  const [userId, setUserId] = useState<string | null>(null);
  const [alias, setAlias] = useState("anon");
  const [showLoginModal, setShowLoginModal] = useState(false);
  const [showUserModal, setShowUserModal] = useState(false);
  const [showProfileModal, setShowProfileModal] = useState(false);
  const [importPassword, setImportPassword] = useState("");
  const [isCreatingAccount, setIsCreatingAccount] = useState(false);
  const [isCopied, setIsCopied] = useState(false);
  const [isLoggedIn, setIsLoggedIn] = useState(false);
  const [userPassword, setUserPassword] = useState("");
  const [hasLoggedIn, setHasLoggedIn] = useState(false);
  const [credits, setCredits] = useState(0.000777); // Default to 0.000777 credits
  const [totalBurnedCredits, setTotalBurnedCredits] = useState(0);
  const [accruedValue, setAccruedValue] = useState(0);
  const [isFundingAccount, setIsFundingAccount] = useState(false);
  const [isTokenEconomicsOpen, setIsTokenEconomicsOpen] = useState(false); // New state for token economics accordion
  const [showGlobalDistribution, setShowGlobalDistribution] = useState(false);
  const [showDistributionHistory, setShowDistributionHistory] = useState(false);
  const [isSaving, setIsSaving] = useState(false); // New state for saving status
  const [saveLog, setSaveLog] = useState<string | null>(null); // New state for operation log
  const [saveSuccess, setSaveSuccess] = useState(false); // New state for save success
  const [isInflationMetricsOpen, setIsInflationMetricsOpen] = useState(false); // New state for inflation metrics accordion
  
  // Global token metrics state
  const [globalTokenMetrics, setGlobalTokenMetrics] = useState<{
    totalIssued: number;
    circulating: number;
    totalBurned: number;
    lastUpdated: Date;
    distributionProgress: number;
    tokensPerHuman?: number;
    targetPopulation?: number;
    distributionTimeframe?: string;
  }>({
    totalIssued: 0,
    circulating: 0,
    totalBurned: 0,
    lastUpdated: new Date(),
    distributionProgress: 0,
    tokensPerHuman: 1000000,
    targetPopulation: 10000000000,
    distributionTimeframe: '2025-2035'
  });
  
  // Token distribution history
  const [tokenDistributionHistory, setTokenDistributionHistory] = useState<Array<{
    time: Date;
    totalIssued: number;
    totalBurned: number;
    circulating: number;
  }>>([]);
  
  // Function to fetch burned credits
  const fetchBurnedCredits = async () => {
    try {
      console.log('Fetching burned credits...');
      const response = await fetch('/api/account/burned-credits');
      if (!response.ok) {
        throw new Error(`Failed to fetch burned credits: ${response.status}`);
      }
      
      const data = await response.json();
      setTotalBurnedCredits(data.totalBurned || 0);
      
      // Update global metrics based on burned credits if the metrics API fails
      if (!globalTokenMetrics.lastUpdated) {
        const totalIssued = 100000000; // Placeholder for total issued
        const totalBurned = data.totalBurned || 0;
        const circulating = totalIssued - totalBurned;
        
        setGlobalTokenMetrics({
          totalIssued,
          circulating,
          totalBurned,
          lastUpdated: new Date(),
          distributionProgress: (totalIssued / 10000000000000) * 100, // 10,000T tokens target
          tokensPerHuman: 1000000,
          targetPopulation: 10000000000,
          distributionTimeframe: '2025-2035'
        });
        
        // Add to history if we don't have any entries yet
        if (tokenDistributionHistory.length === 0) {
          setTokenDistributionHistory([
            {
              time: new Date(),
              totalIssued,
              totalBurned,
              circulating
            }
          ]);
        }
      }
      
      console.log('Burned credits fetched:', data.totalBurned);
    } catch (error) {
      console.error('Error fetching burned credits:', error);
    }
  };
  
  // Fetch global token metrics
  const fetchGlobalTokenMetrics = async () => {
    try {
      const response = await fetch('/api/token-metrics');
      // Only process data if response is OK
      if (response.ok) {
        const data = await response.json();
        
        // Update global metrics
        setGlobalTokenMetrics({
          totalIssued: data.totalIssued || 0,
          circulating: data.circulating || 0,
          totalBurned: data.totalBurned || 0,
          lastUpdated: new Date(),
          distributionProgress: data.distributionProgress || 0.000000,
          tokensPerHuman: data.tokensPerHuman || 1000000,
          targetPopulation: data.targetPopulation || 10000000000,
          distributionTimeframe: data.distributionTimeframe || '2025-2035'
        });
        
        // Update history if available
        if (data.history && Array.isArray(data.history) && data.history.length > 0) {
          setTokenDistributionHistory(data.history.map((item: any) => ({
            time: new Date(item.time),
            totalIssued: item.totalIssued || 0,
            totalBurned: item.totalBurned || 0,
            circulating: item.circulating || 0
          })));
        }
      } else {
        console.log("Token metrics feature not available yet");
        // Use burned credits as a fallback if available
        if (totalBurnedCredits) {
          setGlobalTokenMetrics(prev => ({
            ...prev,
            totalBurned: totalBurnedCredits,
            lastUpdated: new Date()
          }));
        }
      }
    } catch (error) {
      console.error("Failed to fetch global token metrics:", error);
      // Use burned credits as a fallback if available
      if (totalBurnedCredits) {
        setGlobalTokenMetrics(prev => ({
          ...prev,
          totalBurned: totalBurnedCredits,
          lastUpdated: new Date()
        }));
      }
    }
  };

  // Timer interval
  useEffect(() => {
    if (!sessionStart) return;
    
    const update = () => {
      const newElapsed = Math.floor((Date.now() - sessionStart) / 1000);
      setElapsed(newElapsed);
      // Calculate accrued value based on elapsed time
      // Base rate of 0.0001 per second
      setAccruedValue(newElapsed * 0.0001);
    };
    
    update(); // Initial update
    const interval = setInterval(update, 1000);
    return () => clearInterval(interval);
  }, [sessionStart]);

  // Implement handleUpdateAlias function for ProfileModal
  const handleUpdateAlias = async (newAlias: string) => {
    if (!userId) return;
    
    try {
      const response = await fetch('/api/account/update-alias', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ userId, newAlias }),
      });
      
      const data = await response.json();
      
      if (!response.ok) {
        throw new Error(data.error || 'Failed to update alias');
      }
      
      // Update state with new alias and credits
      setAlias(data.alias);
      setCredits(data.credits);
      
      // Update in localStorage
      localStorage.setItem('bubiwot_user_alias', data.alias);
      
      // Refresh burned credits
      fetchBurnedCredits();
      
      alert(`Name updated successfully to ${data.alias}`);
    } catch (error) {
      console.error("Failed to update alias:", error);
      throw error;
    }
  };
  
  // Implement handleSwitchAccount function for ProfileModal
  const handleSwitchAccount = async (password: string) => {
    if (!userId) return;
    
    try {
      const response = await fetch('/api/account/switch', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ userId, password }),
      });
      
      const data = await response.json();
      
      if (!response.ok) {
        throw new Error(data.error || 'Failed to switch account');
      }
      
      // Update state with new user data
      setUserId(data.userId);
      setAlias(data.alias);
      setUserPassword(data.password);
      setHasLoggedIn(data.hasLoggedIn);
      setCredits(data.credits);
      setIsLoggedIn(true);
      
      // Update in localStorage
      localStorage.setItem('bubiwot_user_id', data.userId);
      localStorage.setItem('bubiwot_user_alias', data.alias);
      localStorage.setItem('bubiwot_user_password', data.password);
      localStorage.setItem('bubiwot_user_has_logged_in', 'true');
      
      // Refresh burned credits
      fetchBurnedCredits();
      
      // Close the profile modal
      setShowProfileModal(false);
      
      alert(`Switched to account: ${data.alias}`);
    } catch (error) {
      console.error("Failed to switch account:", error);
      throw error;
    }
  };
  
  // Handle manual save of tokens (costs 0.1 tokens)
  const handleManualSave = async () => {
    if (!userId || accruedValue < 0.1) {
      return;
    }
    
    setIsSaving(true);
    setSaveLog('');
    setSaveSuccess(false);
    
    try {
      const response = await fetch('/api/account/manual-save', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          userId: userId,
          secondsElapsed: elapsed,
          sessionId: localStorage.getItem('bubiwot_session_id') || uuidv4(),
          saveTime: new Date().toISOString(),
        }),
      });
      
      const data = await response.json();
      
      if (!response.ok) {
        throw new Error(data.error || 'Failed to save account');
      }
      
      // Update credits state with new value
      setCredits(data.credits);
      
      // Set the operation log
      setSaveLog(JSON.stringify(data.log, null, 2));
      setSaveSuccess(true);
      
      // Reset session start to now so accrued value resets
      const newSessionStart = Date.now();
      localStorage.setItem('bubiwot_session_start', newSessionStart.toString());
      setSessionStart(newSessionStart);
      setElapsed(0);
      setAccruedValue(0);
      
      // Refresh burned credits after saving
      fetchBurnedCredits();
      
      // Dispatch custom event to notify listeners that a manual save was completed
      window.dispatchEvent(new CustomEvent('manual-save-complete'));
    } catch (err) {
      console.error("Failed to save account:", err);
      setSaveLog(`Error: ${err instanceof Error ? err.message : 'Unknown error'}`);
      setSaveSuccess(false);
    } finally {
      setIsSaving(false);
    }
  };
  
  const openUserModal = () => setShowUserModal(true);
  
  // Utility functions
  const openDiscord = () => window.open("https://discord.gg/WGFvG8vv", "_blank");
  const donate = (id: number) => alert(`Donate to message ${id}!`);
  const viewAllMessages = () => alert("View all messages coming soon!");
  const closeLoginModal = () => setShowLoginModal(false);
  
  // Login and account management
  const handleLoginFromModal = async (password: string) => {
    try {
      const response = await fetch('/api/account/login', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ password }),
      });
      
      const data = await response.json();
      
      if (!response.ok) {
        throw new Error(data.error || 'Login failed');
      }
      
      // Update localStorage
      localStorage.setItem('bubiwot_user_id', data.userId);
      localStorage.setItem('bubiwot_user_alias', data.alias);
      localStorage.setItem('bubiwot_user_password', password);
      localStorage.setItem('bubiwot_user_has_logged_in', 'true');
      
      // Update state
      setUserId(data.userId);
      setAlias(data.alias);
      setUserPassword(password);
      setHasLoggedIn(true);
      setIsLoggedIn(true);
      
      // Close modal
      setShowLoginModal(false);
      
      // Fetch user credits
      fetchUserCredits(data.userId);
      
      // Show success message
      alert("Login successful!");
    } catch (error) {
      console.error("Login failed:", error);
      alert(`Login failed: ${error instanceof Error ? error.message : "Unknown error"}`);
    }
  };
  
  const handleLogout = () => {
    // Clear user data from localStorage
    localStorage.removeItem('bubiwot_user_id');
    localStorage.removeItem('bubiwot_user_alias');
    localStorage.removeItem('bubiwot_user_password');
    localStorage.removeItem('bubiwot_user_has_logged_in');
    
    // Reset state
    setUserId(null);
    setAlias("anon");
    setUserPassword("");
    setHasLoggedIn(false);
    setIsLoggedIn(false);
    setCredits(0.000777); // Reset credits to default
    
    // Close modals if open
    setShowUserModal(false);
    setShowProfileModal(false);
  };
  
  // Handle funding account from accrued value
  const handleFundAccount = async () => {
    if (!userId || accruedValue < 0.000777) {
      return;
    }
    
    setIsFundingAccount(true);
    
    try {
      const response = await fetch('/api/write/user/fund_account', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          userId: userId,
          secondsElapsed: elapsed,
          sessionId: localStorage.getItem('bubiwot_session_id') || uuidv4(),
        }),
      });
      
      const data = await response.json();
      
      if (!response.ok) {
        throw new Error(data.message || 'Failed to fund account');
      }
      
      // Update credits state with new value
      setCredits(data.credits);
      
      // Reset session start to now so accrued value resets
      const newSessionStart = Date.now();
      localStorage.setItem('bubiwot_session_start', newSessionStart.toString());
      setSessionStart(newSessionStart);
      setElapsed(0);
      setAccruedValue(0);
      
      // Refresh burned credits after funding
      fetchBurnedCredits();
      
      // Dispatch custom event to notify listeners that a fund account was completed
      window.dispatchEvent(new CustomEvent('fund-account-complete'));
    } catch (err) {
      console.error("Failed to fund account:", err);
    } finally {
      setIsFundingAccount(false);
    }
  };
  
  // Fetch user credits
  const fetchUserCredits = async (uid: string) => {
    try {
      console.log(`Fetching credits for user ${uid}...`);
      const response = await fetch(`/api/account/get-credits?userId=${uid}`);
      
      if (response.ok) {
        const data = await response.json();
        console.log(`Credits updated: ${data.credits}`);
        setCredits(data.credits);
      } else {
        const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
        console.error(`Failed to fetch credits: ${errorData.error || response.statusText}`);
      }
    } catch (error) {
      console.error("Failed to fetch user credits:", error);
    }
  };

  return (
    <div className="min-h-screen bg-white flex flex-col">
      {/* Header */}
      <header className="flex items-center justify-between px-4 py-3 border-b border-gray-100">
        <span className="text-sm font-extralight tracking-wider text-gray-600">Bitcoin UBI Web-of-Trust</span>
        <div className="ml-auto">
          {!isLoggedIn ? (
            <Link href="/protowhitepaper/" className="text-sm text-blue-600 hover:underline">
              docs/whitepaper
            </Link>
          ) : (
            <button 
              onClick={openUserModal} 
              className="text-sm text-green-600 hover:underline cursor-pointer"
            >
              {alias}
            </button>
          )}
        </div>
      </header>

      {/* Main Scrollable Content */}
      <main className="flex-1 overflow-y-auto">
        {/* Whitepaper Link Banner - Removed */}
        
        {/* Hero Section */}
        <section id="hero" className="px-4 py-8 flex flex-col items-start">
          {/* User Stats Panel - Redesigned and Left-aligned */}
          <div className="w-full max-w-md mx-auto bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-6">
            <h3 className="text-sm font-medium text-gray-700 mb-3">User Profile</h3>
            
            <div className="space-y-2">
              {/* Alias */}
              <div className="flex items-center justify-between">
                <span className="text-xs text-gray-500">Name:</span>
                <div className="flex items-center gap-2">
                  <span className="text-sm font-medium">{alias}</span>
                  <button 
                    onClick={() => setShowProfileModal(true)}
                    className="text-xs text-blue-600 hover:underline"
                  >
                    edit
                  </button>
                </div>
              </div>
              
              {/* User ID */}
              {userId && (
                <div className="flex items-center justify-between">
                  <span className="text-xs text-gray-500">ID:</span>
                  <span className="text-sm font-mono text-gray-700 truncate max-w-[200px]">{userId}</span>
                </div>
              )}
              
              {/* Password (hidden with toggle) */}
              {userPassword && (
                <div className="flex items-center justify-between">
                  <span className="text-xs text-gray-500">Password:</span>
                  <div className="flex items-center gap-1">
                    <button 
                      onClick={() => {
                        // Toggle password visibility with proper type casting
                        const passwordField = document.getElementById('user-password') as HTMLInputElement;
                        if (passwordField) {
                          passwordField.type = passwordField.type === 'password' ? 'text' : 'password';
                        }
                      }}
                      className="text-gray-500 hover:text-gray-700"
                      title="Toggle visibility"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                      </svg>
                    </button>
                    <input 
                      id="user-password"
                      type="password" 
                      value={userPassword} 
                      readOnly 
                      className="text-sm font-mono bg-transparent border-none w-24 focus:outline-none"
                    />
                    <button 
                      onClick={() => {
                        navigator.clipboard.writeText(userPassword);
                        // You could add a small toast notification here
                      }}
                      className="text-gray-500 hover:text-gray-700"
                      title="Copy to clipboard"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                      </svg>
                    </button>
                  </div>
                </div>
              )}
              
              {/* Credits */}
              <div className="flex items-center justify-between">
                <span className="text-xs text-gray-500">Credits:</span>
                <span className="text-sm font-medium text-green-600">{credits.toFixed(8)} Â¤</span>
              </div>
              
              {/* Inflation Metrics - Collapsible Section */}
              <div className="mt-1 border-t border-gray-100 pt-1">
                <button 
                  type="button"
                  className="flex items-center justify-between w-full text-left"
                  onClick={() => setIsInflationMetricsOpen(!isInflationMetricsOpen)}
                >
                  <h4 className="text-xs font-medium text-gray-700">Inflation Metrics</h4>
                  <svg 
                    xmlns="http://www.w3.org/2000/svg" 
                    className={`h-4 w-4 text-gray-500 transition-transform ${isInflationMetricsOpen ? 'rotate-180' : ''}`} 
                    fill="none" 
                    viewBox="0 0 24 24" 
                    stroke="currentColor"
                  >
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                  </svg>
                </button>
                
                <div 
                  className={`mt-2 text-xs bg-gray-50 rounded-md transition-all ${isInflationMetricsOpen ? 'block' : 'hidden'}`}
                >
                  {/* Counter display */}
                  <div className="text-center p-3 border-b border-gray-200">
                    <motion.div
                      key={elapsed}
                      initial={{ opacity: 0.9, y: -2 }}
                      animate={{ opacity: 1, y: 0 }}
                      transition={{ duration: 0.15, ease: "easeOut" }}
                      className="inline-block"
                    >
                      <span className="text-3xl font-bold text-gray-900">~Â¤{(elapsed * 0.0001).toFixed(2)}</span>
                      <div className="text-xs text-gray-500 mt-1">Accrued value</div>
                    </motion.div>
                    
                    <div className="mt-2 mb-3">
                      <button
                        className="px-6 py-2 text-sm bg-gray-300 text-gray-700 rounded-md cursor-not-allowed"
                        disabled
                      >
                        Send
                      </button>
                    </div>
                    
                    {/* Progress bar */}
                    <div className="w-full bg-gray-200 rounded-full h-4 overflow-hidden shadow-inner">
                      <div 
                        className="h-4 rounded-full bg-gradient-to-r from-green-500 to-blue-600"
                        style={{ 
                          width: `${Math.min(((elapsed * 0.0001) / 260) * 100, 100)}%`, 
                          transition: 'width 0.5s ease-out' 
                        }}
                      ></div>
                    </div>
                    <div className="text-center text-xs text-gray-600 mt-1">
                      {(Math.min(((elapsed * 0.0001) / 260) * 100, 100)).toFixed(1)}% of Â¤260 monthly target
                    </div>
                  </div>
                  
                  {/* Inflation Trend Dashboard */}
                  <div className="p-3">
                    <h3 className="text-sm font-medium text-gray-700 mb-2">Inflation Trend Dashboard</h3>
                    <InflationTrendDashboard elapsed={elapsed} />
                  </div>
                </div>
              </div>
              
              {/* Real-time Accrual Display */}
              <div className="flex items-center justify-between mt-2 bg-blue-50 p-3 rounded-md border border-blue-100">
                <div>
                  <span className="text-xs text-gray-700 font-medium">Accruing:</span>
                  <div className="text-lg font-mono text-blue-600 font-semibold">
                    <motion.span
                      key={Math.floor(elapsed)}
                      initial={{ opacity: 0.8 }}
                      animate={{ opacity: 1 }}
                      transition={{ duration: 0.3 }}
                    >
                      {accruedValue.toFixed(8)} Â¤
                    </motion.span>
                  </div>
                  <div className="text-xs text-gray-500">Â¤0.0001/second</div>
                </div>
                <button
                  onClick={handleManualSave}
                  disabled={accruedValue < 0.1 || isSaving}
                  className="px-3 py-2 text-xs bg-blue-500 text-white rounded-md hover:bg-blue-600 disabled:bg-blue-300 disabled:cursor-not-allowed flex items-center"
                >
                  {isSaving ? (
                    <>
                      <svg className="animate-spin -ml-1 mr-1 h-3 w-3 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                      </svg>
                      Saving...
                    </>
                  ) : (
                    <>Save (costs Â¤0.1)</>
                  )}
                </button>
              </div>
              
              {/* Operation Log */}
              {saveLog && (
                <div className="mt-2 p-2 bg-gray-50 rounded-md border border-gray-200 text-xs font-mono overflow-auto max-h-40">
                  <div className="font-medium text-gray-700 mb-1">Operation Log:</div>
                  <pre className="whitespace-pre-wrap text-gray-600">{saveLog}</pre>
                  {saveSuccess && (
                    <div className="mt-1 text-green-600 font-medium">âœ“ Save successful!</div>
                  )}
                </div>
              )}
              
              {/* Login Status */}
              <div className="flex items-center justify-between">
                <span className="text-xs text-gray-500">Status:</span>
                <span className="text-xs px-2 py-0.5 rounded-full bg-gray-100">
                  {isLoggedIn ? (
                    <span className="text-green-600">Logged In</span>
                  ) : (
                    <span className="text-yellow-600">unknown user</span>
                  )}
                </span>
              </div>
              
              {/* Session Time */}
              <div className="flex items-center justify-between">
                <span className="text-xs text-gray-500">Session:</span>
                <span className="text-sm">{formatElapsed(elapsed)}</span>
              </div>
              
              {/* User Count */}
              <div className="flex items-center justify-between">
                <span className="text-xs text-gray-500">Total Users:</span>
                <span className="text-sm">{userCount}</span>
              </div>
              
              {/* Token Economics - Collapsible Section */}
              <div className="mt-3 pt-3 border-t border-gray-200">
                <button 
                  type="button"
                  className="flex items-center justify-between w-full text-left"
                  onClick={() => setIsTokenEconomicsOpen(!isTokenEconomicsOpen)}
                >
                  <h4 className="text-xs font-medium text-gray-700">Token Economics</h4>
                  <svg 
                    xmlns="http://www.w3.org/2000/svg" 
                    className={`h-4 w-4 text-gray-500 transition-transform ${isTokenEconomicsOpen ? 'rotate-180' : ''}`} 
                    fill="none" 
                    viewBox="0 0 24 24" 
                    stroke="currentColor"
                  >
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                  </svg>
                </button>
                
                <div 
                  className={`mt-2 text-xs bg-gray-50 p-3 rounded-md transition-all ${isTokenEconomicsOpen ? 'block' : 'hidden'}`}
                >
                  <div className="mb-3">
                    <span className="font-medium text-gray-700">Token Accrual:</span>
                    <ul className="list-disc pl-4 mt-1 text-gray-600 space-y-1">
                      <li>You earn Â¤0.0001 per second (Â¤8.64 per day)</li>
                      <li>Tokens accrue continuously while session is active</li>
                      <li>Monthly target: Â¤260 (approximately)</li>
                    </ul>
                  </div>
                  
                  <div className="mb-3">
                    <span className="font-medium text-gray-700">Token Usage:</span>
                    <ul className="list-disc pl-4 mt-1 text-gray-600 space-y-1">
                      <li>Change username: Â¤0.000777</li>
                      <li>Switch accounts: Â¤0.000777</li>
                      <li>Fund account: minimum Â¤0.000777</li>
                    </ul>
                  </div>
                  
                  <div className="mb-3">
                    <span className="font-medium text-gray-700">Token System:</span>
                    <p className="mt-1 text-gray-600">
                      Tokens represent your participation in the BUBIWOT ecosystem. All burned tokens are tracked transparently on-chain. As the system grows, more token utilities will be added.
                    </p>
                  </div>
                  
                  {/* Global Token Distribution */}
                  <div className="mb-3 border-t border-gray-200 pt-3">
                    <div 
                      className="flex items-center justify-between cursor-pointer"
                      onClick={() => setShowGlobalDistribution(!showGlobalDistribution)}
                    >
                      <h4 className="font-medium text-gray-700">Global Token Distribution</h4>
                      <svg 
                        xmlns="http://www.w3.org/2000/svg" 
                        className={`h-4 w-4 text-gray-500 transition-transform ${showGlobalDistribution ? 'rotate-180' : ''}`} 
                        fill="none" 
                        viewBox="0 0 24 24" 
                        stroke="currentColor"
                      >
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                      </svg>
                    </div>
                    
                    {showGlobalDistribution && (
                      <>
                        <div className="text-gray-500 text-[10px] mt-1">Last updated: {globalTokenMetrics.lastUpdated ? new Date(globalTokenMetrics.lastUpdated).toLocaleTimeString() : 'Loading...'}</div>
                        
                        <div className="grid grid-cols-3 gap-2 mt-2">
                          <div className="bg-blue-50 p-2 rounded-md text-center">
                            <div className="text-gray-500 text-[10px]">Total Issued</div>
                            <div className="font-medium text-blue-600">{globalTokenMetrics.totalIssued.toLocaleString()}</div>
                          </div>
                          <div className="bg-green-50 p-2 rounded-md text-center">
                            <div className="text-gray-500 text-[10px]">Circulating</div>
                            <div className="font-medium text-green-600">{globalTokenMetrics.circulating.toLocaleString()}</div>
                          </div>
                          <div className="bg-red-50 p-2 rounded-md text-center">
                            <div className="text-gray-500 text-[10px]">Total Burned</div>
                            <div className="font-medium text-red-600">{globalTokenMetrics.totalBurned.toLocaleString()}</div>
                          </div>
                        </div>
                        
                        <div className="mt-3 bg-gray-100 p-2 rounded-md">
                          <div className="text-center font-medium mb-1">Projected Distribution: 10000.00T Tokens</div>
                          <div className="flex items-center justify-between text-[10px] text-gray-500 mb-1">
                            <span>{globalTokenMetrics.distributionProgress.toFixed(8)}% Complete</span>
                          </div>
                          <div className="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                            <div 
                              className="h-2 bg-blue-600 rounded-full" 
                              style={{ width: `${Math.min(globalTokenMetrics.distributionProgress, 100)}%` }}
                            ></div>
                          </div>
                          <div className="flex justify-between text-[10px] text-gray-600 mt-1">
                            <span>2025</span>
                            <span>Now</span>
                            <span>2035</span>
                          </div>
                          
                          <div className="mt-2 grid grid-cols-2 gap-2">
                            <div className="bg-white p-1 rounded text-center">
                              <div className="text-[10px] text-gray-500">Per Human</div>
                              <div className="font-medium">{globalTokenMetrics.tokensPerHuman?.toLocaleString() || "1M"} Tokens</div>
                            </div>
                            <div className="bg-white p-1 rounded text-center">
                              <div className="text-[10px] text-gray-500">Target Population</div>
                              <div className="font-medium">{globalTokenMetrics.targetPopulation?.toLocaleString() || "10B"} Humans</div>
                            </div>
                          </div>
                          
                          <div className="mt-2 text-[10px] text-gray-600 text-center">
                            Projecting distribution of 1M tokens per human to 10B humans by 2035 (10 years remaining)
                          </div>
                        </div>
                      </>
                    )}
                  </div>
                  
                  {/* Token Distribution History */}
                  <div className="mb-3 border-t border-gray-200 pt-3">
                    <div 
                      className="flex items-center justify-between cursor-pointer"
                      onClick={() => setShowDistributionHistory(!showDistributionHistory)}
                    >
                      <h4 className="font-medium text-gray-700">Token Distribution History</h4>
                      <svg 
                        xmlns="http://www.w3.org/2000/svg" 
                        className={`h-4 w-4 text-gray-500 transition-transform ${showDistributionHistory ? 'rotate-180' : ''}`} 
                        fill="none" 
                        viewBox="0 0 24 24" 
                        stroke="currentColor"
                      >
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                      </svg>
                    </div>
                    
                    {showDistributionHistory && (
                      <>
                        <div className="text-gray-500 text-[10px] mt-1">Last updated: {globalTokenMetrics.lastUpdated ? new Date(globalTokenMetrics.lastUpdated).toLocaleTimeString() : 'Loading...'}</div>
                        
                        <div className="mt-2 overflow-x-auto">
                          <table className="min-w-full text-[10px]">
                            <thead className="bg-gray-100">
                              <tr>
                                <th className="px-2 py-1 text-left">Time</th>
                                <th className="px-2 py-1 text-right">Total Issued</th>
                                <th className="px-2 py-1 text-right">Total Burned</th>
                                <th className="px-2 py-1 text-right">Circulating</th>
                              </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-200">
                              {tokenDistributionHistory.length > 0 ? (
                                tokenDistributionHistory.map((entry, index) => (
                                  <tr key={index}>
                                    <td className="px-2 py-1 whitespace-nowrap">{entry.time.toLocaleString()}</td>
                                    <td className="px-2 py-1 text-right">{entry.totalIssued.toLocaleString()}</td>
                                    <td className="px-2 py-1 text-right">{entry.totalBurned.toLocaleString()}</td>
                                    <td className="px-2 py-1 text-right">{entry.circulating.toLocaleString()}</td>
                                  </tr>
                                ))
                              ) : (
                                <tr>
                                  <td colSpan={4} className="px-2 py-1 text-center">No history data available</td>
                                </tr>
                              )}
                            </tbody>
                          </table>
                        </div>
                        
                        <div className="mt-2 text-center text-[10px] text-gray-500">
                          Limited to most recent entries. Full history available for analysis.
                        </div>
                      </>
                    )}
                  </div>
                  
                    
                    <div className="mt-2 overflow-x-auto">
                      <table className="min-w-full text-[10px]">
                        <thead className="bg-gray-100">
                          <tr>
                            <th className="px-2 py-1 text-left">Time</th>
                            <th className="px-2 py-1 text-right">Total Issued</th>
                            <th className="px-2 py-1 text-right">Total Burned</th>
                            <th className="px-2 py-1 text-right">Circulating</th>
                          </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-200">
                          <tr>
                            <td className="px-2 py-1 whitespace-nowrap">{new Date().toLocaleString()}</td>
                            <td className="px-2 py-1 text-right">{totalBurnedCredits.toFixed(8)}</td>
                            <td className="px-2 py-1 text-right">{totalBurnedCredits.toFixed(8)}</td>
                            <td className="px-2 py-1 text-right">0.00000000</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                    
                    <div className="mt-2 text-center text-[10px] text-gray-500">
                      Limited to most recent entries. Full history available for analysis.
                    </div>
                  </div>
                  
                  <div className="text-center text-xs text-gray-600 mt-3 p-1 bg-blue-50 rounded-md">
                    Currently accrued: Â¤{accruedValue.toFixed(4)}
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div className="w-full flex flex-col items-center text-center">
            {/* Finance Dashboard Component - Removing since we moved to collapsible section */}
            {/* Token Distribution Components */}
            <TokenDistributionMap />
            <TokenDistributionTable />
            
            <h1 className="text-2xl font-bold text-black mt-4">You are earning Bitcoin UBI Now ðŸ’ª</h1>
            <p className="text-sm text-black mt-2">We&apos;re working to let you cash out in BTC! ðŸ‘·</p>
            <button
              className="px-8 mx-auto bg-gray-400 text-white rounded-lg py-3 mt-4 font-semibold text-base cursor-not-allowed"
              disabled
            >
              <span className="line-through">Cash Out</span> <span>(Coming Soon)</span>
            </button>
            <div className="flex w-full justify-center gap-6 mt-3">
              <div className="flex items-center gap-1">
                <svg width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
                  <path d="M17 20h5v-2a4 4 0 0 0-3-3.87"/>
                  <path d="M9 20H4v-2a4 4 0 0 1 3-3.87"/>
                  <circle cx="12" cy="7" r="4"/>
                </svg>
                <span className="text-xs text-black">Joined</span>
                <span className="ml-1 font-semibold text-xs text-black">{userCount}</span>
              </div>
              <div className="flex items-center gap-1">
                <svg width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
                  <path d="M16 13a4 4 0 1 0-8 0v5a4 4 0 1 0 8 0v-5z"/>
                  <circle cx="12" cy="7" r="4"/>
                </svg>
                <span className="text-xs text-black">Total</span>
                <span className="ml-1 font-semibold text-xs text-black">{totalBubi} BUBI</span>
              </div>
            </div>
          </div>
        </section>

        {/* Video Section (replaces old video section) */}
        <VideoSection />

        {/* Quick Tasks */}
        <section id="tasks" className="px-4 py-8">
          <h2 className="text-lg font-bold mb-3 text-black">Get Involved</h2>
          <ul className="flex flex-col gap-3">
            {tasks.map((task) => (
              <li 
                key={task.id} 
                className={`flex items-center bg-gray-100 rounded-lg px-3 py-2 ${task.title.includes("Join Discord") ? "cursor-pointer hover:bg-gray-200" : ""}`}
                onClick={task.title.includes("Join Discord") ? openDiscord : undefined}
              >
                <span className="flex-1 text-sm text-black">{task.title}</span>
                {task.title.includes("Join Discord") && (
                  <svg 
                    className="h-5 w-5 mr-2 text-indigo-500" 
                    fill="currentColor" 
                    viewBox="0 0 24 24"
                  >
                    <path d="M20.317 4.492c-1.53-.69-3.17-1.2-4.885-1.49a.075.075 0 0 0-.079.036c-.21.39-.444.906-.608 1.31a16.98 16.98 0 0 0-5.092 0c-.164-.404-.4-.92-.61-1.31a.077.077 0 0 0-.079-.036c-1.714.29-3.354.8-4.885 1.49a.07.07 0 0 0-.032.027C.533 9.093-.32 13.555.099 17.961a.08.08 0 0 0 .031.055c1.994 1.465 3.922 2.355 5.803 2.945a.082.082 0 0 0 .089-.028c.39-.53.739-1.09 1.039-1.675a.075.075 0 0 0-.041-.106 11.95 11.95 0 0 1-1.708-.817.075.075 0 0 1-.007-.125c.114-.086.228-.176.336-.267a.075.075 0 0 1 .079-.01c3.954 1.809 8.232 1.809 12.143 0a.075.075 0 0 1 .08.01c.108.091.222.182.337.267a.075.075 0 0 1-.007.125c-.545.308-1.113.588-1.709.818a.075.075 0 0 0-.041.106c.305.581.654 1.142 1.038 1.675a.076.076 0 0 0 .089.028c1.88-.59 3.809-1.48 5.804-2.945a.077.077 0 0 0 .03-.055c.5-5.177-.838-9.596-3.549-13.442a.06.06 0 0 0-.031-.027zM8.02 15.278c-1.144 0-2.089-1.055-2.089-2.345 0-1.29.924-2.344 2.089-2.344 1.174 0 2.09 1.064 2.074 2.344 0 1.29-.925 2.345-2.075 2.345zm7.676 0c-1.145 0-2.09-1.055-2.09-2.345 0-1.29.925-2.344 2.09-2.344 1.174 0 2.09 1.064 2.073 2.344 0 1.29-.925 2.345-2.074 2.345z"/>
                  </svg>
                )}
                <div className="px-3 py-1 text-xs bg-gray-300 text-gray-700 rounded transition cursor-default">
                  Reward: 0 BUBI
                </div>
              </li>
            ))}
          </ul>
        </section>

        {/* Leaderboard */}
        <section id="leaderboard" className="px-4 py-8 bg-gray-50">
          <h2 className="text-lg font-bold mb-3 text-black">Top Donors</h2>
          <ul className="flex flex-col gap-2">
            {messages.slice(0, 5).map((msg, i) => (
              <li key={msg.id} className="flex items-center bg-white rounded-lg px-3 py-2 shadow-sm">
                <span className="w-8 text-center text-xs font-bold text-black">{i + 1}</span>
                <span className="flex-1 text-sm truncate text-black">
                  <span className="italic">&quot;{msg.text}&quot;</span>
                  <span className="ml-2 text-xs text-gray-600">&mdash;{msg.name}</span>
                </span>
                <button
                  className="ml-2 px-3 py-1 text-xs bg-yellow-400 text-black rounded hover:bg-yellow-300 transition"
                  onClick={() => donate(msg.id)}
                >
                  {msg.total_sats >= 1000000 
                    ? `${(msg.total_sats / 1000000).toFixed(1)}M` 
                    : msg.total_sats} sats
                </button>
              </li>
            ))}
          </ul>
          <button
            className="w-full mt-2 py-2 text-sm bg-gray-200 rounded hover:bg-gray-300 transition text-black"
            onClick={viewAllMessages}
          >
            View All
          </button>
        </section>

        {/* Footer */}
        <footer className="px-4 py-8 flex flex-col items-center text-center gap-2">
          <div className="flex gap-4 mb-2">
            <a className="text-blue-600 underline text-sm" href="mailto:bobby@formulax.dev">bobby@formulax.dev</a>
            {/* Login button removed */}
          </div>
          <span className="text-xs text-gray-800 mt-2">Â© 2025 BUBIWOT Protocol</span>
          <span className="text-xs text-gray-700 mt-1">
            Donate BTC: bc1q2hcaje8l7uzsc2jdfhe3svfczy3mlxeuvuet8h
          </span>
          <span className="text-xs text-gray-700 mt-1">
            Total Burned Credits: {totalBurnedCredits}
          </span>
        </footer>
      </main>
      <Analytics />
      <LoginModal isOpen={showLoginModal} onClose={closeLoginModal} />
      <UserModal 
        isOpen={showUserModal} 
        onClose={() => setShowUserModal(false)} 
        userData={{
          userId: userId || "",
          alias,
          password: userPassword,
          hasLoggedIn
        }}
        onLogin={handleLoginFromModal}
        _onLogout={handleLogout} 
      />
      <ProfileModal
        isOpen={showProfileModal}
        onClose={() => setShowProfileModal(false)}
        userData={{
          userId: userId || '',
          alias,
          credits,
        }}
        accruedValue={accruedValue}
        isFundingAccount={isFundingAccount}
        onUpdateAlias={handleUpdateAlias}
        onSwitchAccount={handleSwitchAccount}
        onFundAccount={handleFundAccount}
      />
    </div>
  );
}
